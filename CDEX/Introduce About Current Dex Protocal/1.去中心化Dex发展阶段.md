Dex 经历了三个主要技术阶段

### 第一阶段

去中心化交易技术始于以太坊的诞生。中心化交易系统的主要模块都被搬到了DEX智能合约里，包括订单本（Order Book)，撮合引擎（Match Engine），清结算子系统（Settlement Subsystem），账号子系统（Account Subsystem），以及充值提现子系统（Deposit & Withdrawal）。

#### 技术特点

第一阶段的技术有几个特点。首先它非常简单。以太坊上的EtherDelta就是这种技术的代表，它的[主合约](https://github.com/etherdelta/smart_contract/blob/master/etherdelta.sol)只有三百多行代码。另外它也没有任何链外系统做辅助，全部的逻辑都在区块链上运行，因此它和以太坊主网的去中心化程度一样，安全性也和以太坊的安全性高度一致（前提是智能合约没有安全漏洞）。另外它还有个理论上的优势，就是可以汇聚整个网络的全部流动性。

第一阶段技术致命缺点是吞吐量太低，而费用又太高了。原因很明显：每次提交和取消订单都需要消耗一个以太坊交易。在提交订单的交易里，还要触发订单匹配。如果订单恰巧匹配到了一个或者多个对手单，就要做清结算，记录成交历史，做内部转账；如果订单不能匹配任何对手单，就需要把订单写入订单本。总之，在智能合约层面的逻辑实在是太多，任何合约的代码优化都是杯水车薪。

### 第二阶段

大约是2017年年初，当开发者们意识到第一阶段技术的缺陷时，他们开始尝试去做进一步的优化。路印就是这个时候开始研发自己协议的。实际上路印后来陆续发布的1.0，1.5， 和2.0三个版本都属于第二阶段这个范畴。

这个阶段优化的思路其实很直接： 尽量把与资产安全相关度低的模块从智能合约中移除，放到链外的中心化系统中去运行，这样就可以避免对区块链的过渡依赖，从而提高吞吐量并降低成本。包括路印在内的许多DEX项目把这个链外的中心化系统称为中继（Relayer）。

从智能合约中移除的子系统包括：订单本，撮合引擎。账号子系统和充值提现子系统则被去掉，转而使用以太坊地址作为账号。留在智能合约中的就只有清结算子系统了，这个子系统的主要逻辑是验证订单和撮合的正确性，计算成交量，更新成交记录，并进行资产在链上的原子互换。

第二阶段的DEX产品理论上依然可以汇集整个网络的所有订单，但订单的管理和撮合由于是在中心化系统中完成的，因此就不再是“去中心化”交易所了。但开发者和社区依然把这种技术归类于去中心化技术，其主要原因有两个，第一是用户交易的资产依然是掌握在用户自己的地址中，因此从资产安全的角度讲，依然是“去中心化”，和以太坊的安全性一致的；第二是用户的订单可以被多个中继同时匹配，因此流动性是可以去中心化共享的。对这一阶段技术和产品更准确的一种描述应该是“非托管中心化交易所”技术。

第二阶段技术的优化结果如何呢？假设以太坊15秒出一个块，理论上这种技术每秒可以成交（吞吐量）2到3笔，每个交易消耗的油费大约等值13美分左右 — 这个成本和以太坊价格成正比，13美分是以太价格190美金计算得到的，如果我们期待以太价格未来会更高，那么撮合的成本也会同样增加。这个成本还和中继使用的gas价格相关。

知道了第二阶段技术的性能，如果还有人告诉你这个阶段的去中心化交易所将取代像币安，Coinbase这样的中心化交易所，你会认同吗？我觉得用蚍蜉撼树来比喻也不为过。吞吐量还是太小，成本还是太高了。

如何才能进一步实现DEX的优化性能（这里专指吞吐量和成本）而不依赖于以太坊本身的扩容呢？这是个巨大的挑战。多数的DEX项目到第二阶段就无法实现技术上的突破了，等待主网扩容，成了他们唯一救命稻草。

### 第三阶段

2019年，有两个项目从第二阶段，跨入了第三个阶段。一个是旧金山的StarkWare公司（他们借鉴了0x第二阶段的技术）；另一个就是我们路印协议。其实这两个项目思路十分相似：进一步把逻辑从智能合约中移除，放到链外的中心化系统中去运行；路印协议甚至是将除了转账之外的几乎所有链上逻辑，全部转移到链外的中继里（区块链上的转账是无法移到链外的）。

“*等一下*”，你可能会惊叹，“*那不就和中心化交易所一样了吗？*”

如果只是简单粗暴地那么做，可不就变成中心化交易所了！但是第三阶段技术的一个核心潜台词是“**可信计算**”。换句话说，我们需要通过技术，证明在链外运行的代码逻辑是百分百可信的。这个信任最主要是针对链上对应的智能合约而言，只有智能合约信任链外的计算结果，才做链上的转账。如果智能合约信任链外计算结果，那么用户也就应该可以信任中继的计算结果，进而从总体上信任这种去中心化交易技术。

这里“可信计算”其实没有一个严谨的定义，我是想通过这个比较容易理解的概念，来强调第三阶段技术的一个关键点。目前看来实现可信计算的方式主要由两种：第一种是通过硬件，利用CPU中的可信任计算环境（Trusted Execution Environment，或者叫TEE，有时候也叫Enclave）实现。这种实现方式本质上是基于信任链，而信任链的最顶端是CPU的生产厂家。第二种是通过零知识证明（Zero-Knowledge Proofs，或者叫ZKP）实现，即ZK Rollup。这是基于数学无需信任的一种技术方式。

路印倾向于现在和未来都不信任硬件厂商，原因再简单不过了：我们假设Intel自己做了一个中心化交易所，我们会信任这个交易所吗？如果CPU厂商值得信任，我们是不是就不该浪费生命开发DEX了，直接把交易所这个商机让给CPU厂商不就完了？

那么第三阶段技术和第二阶段比起来有什么不同呢？这个值得说一说，否则当我们说到第四代，第五代技术的时候就无从下笔了。

第一个不同点是：清结算也转移到了链外的中继里。从用户体验角度，最直接的不同是交易几乎是实时完成的，这一点和中心化交易所几乎是一样的。另外在第二阶段主要消耗油费的结算子系统也不再消耗那么多费用了。进而实现了两个重要的特点：1）用户感知的交易所实时性，和2）交易成本的降低。

第二个不同点是：只需要把可信计算的证明（proof）数据存储到区块链上。这个证明其实很小，而且只需要定期地给一大批交易生产一个证明。比如在路印3.0最新的beta3版本中，可以为10万个交易只生成一个256字节的零知识证明。如果定性说第二阶段技术是每笔交易清结算都上链，那么第三阶段就是大批量交易的证明上链。不管从存储角度，还是从计算角度，第三阶段对区块链的使用都降低了数十倍，甚至数百倍，数千倍，因此极大提高了区块链的使用效率。

第三个不同点是：订单，即流动性，再也无法跨中继共享了。第三阶段的订单必须指定只有特定的中继才能去做可信计算。这是为了性能而做的取舍，否则多个中继协调起来就无法做到用户感知的交易所实时性，同时也会极大增加系统的复杂度。但这个缺点后续并非不可解决。

第四个不同点是：中继在区块链外维护了一个交易账号系统，用户需要对该系统做充值才可以下单做交易，交易后可以提现获取区块链上真正的资产。这个改变的缺点是用户需要充值提现；但它同时也恰恰是个优点，因为这种交互模式和中心化交易所的用户体验是完全一致的。用户甚至还有个交易密码用来对订单进行签名，也就是交易过程中，甚至可以不解锁私钥。另外即使忘记交易密码，也不会损失任何资产。

特别需要做个说明：这个交易账号系统其实是维护在一个叫“树”的结构中的。每个交易所一棵树，这棵树里面记录了每个用户的交易密码对应的公钥，每个用户每种资产的余额，以及每个订单的历史成交量等信息。这棵树其实就是第三阶段DEX链外的“世界状态”，我们可以称之为“**世界状态树**”。

第三阶段技术的安全性如何呢？它和以太坊主网安全性依然是高度一致的。我们在设计路印协议的时候，一直需要做个假设 ：去中心化交易所的拥有者和运营者从第一天起就是想要作恶的。第三阶段技术保证在这个最坏假设下，用户的资产依然百分百和以太坊主网一样安全。在最坏情况下，用户只是在一段时间内无法使用自己充值在DEX中的资产，但过了一小段时间，就可以通过第三方工具将资产全部取回。而基于这种技术的交易所运营者，一旦作恶，只会大量损失自己抵押的信用资产，得不偿失。当然路印3.0设计时也考虑了交易所运营者面对的风险，特别是当中继完全被黑客控制后，我们的技术确保交易所的损失应该只是几天内需要使用的以太坊交易油费的总和。这个损失小到三五千人民币，大到三五万人民币，对一个公司来说，是完全可以承受的。

读到这里，我希望你还没被弄糊涂。你可以在脑海里，这样勾勒出第三阶段技术的一个画面：**一个DEX包含以太坊上的一组智能合约，用来验证可信计算的证明，并在必要的时候做充值提现的转账；它还包含一个在中心化中继系统里的一个很大很大的树，里面包含这个DEX的所有重要信息。**

第三阶段技术的性能怎么样呢？这取决于上面提到的那棵树的容量，容量越大，吞吐量越小，成本越高。路印3.0最新版本采用了四叉树结构（也就是每个节点有四个子节点），在高度设置为21的情况下，最高级别资产安全的情况下每秒交易吞吐量最高是290笔；如果我们稍微降低安全性到联盟链级别，每秒交易吞吐量可达5200笔，而且我们还在近一步优化吞吐量。

每笔交易的成本大约只有人民币5–10分 ， 这个取决于我们所用的云计算服务的费用，因此其变化幅度较大。很重要的一点是，这个费用与以太的费用相关性就更小了，以太价格对整体费用的影响大约是八分之一到十分之一左右。

我们觉得协议这样的吞吐量和交易成本即使和最主流的中心化交易所比也非常有竞争力，毕竟从安全角度看，第三阶段DEX技术依然保障资产和以太坊主网一样安全。不过为了让整个DEX产品的吞吐量上去，还需要努力改进中继的吞吐量 — 一个去中心化交易所真正的吞吐量是协议吞吐量和中继吞吐量的最小值。

