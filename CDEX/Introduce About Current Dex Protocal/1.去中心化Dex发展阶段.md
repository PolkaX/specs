Dex 经历了三个主要技术阶段

### 第一阶段

去中心化交易技术始于以太坊的诞生。中心化交易系统的主要模块都被搬到了 DEX 智能合约里，包括订单本（Order Book)，撮合引擎（Match Engine），清结算子系统（Settlement Subsystem），账号子系统（Account Subsystem），以及充值提现子系统（Deposit & Withdrawal）。

#### 技术特点

第一阶段的技术有几个特点。首先它非常简单。以太坊上的 EtherDelta 就是这种技术的代表，它的[主合约](https://github.com/etherdelta/smart_contract/blob/master/etherdelta.sol)只有三百多行代码。另外它也没有任何链外系统做辅助，全部的逻辑都在区块链上运行，因此它和以太坊主网的去中心化程度一样，安全性也和以太坊的安全性高度一致（前提是智能合约没有安全漏洞）。另外它还有个理论上的优势，就是可以汇聚整个网络的全部流动性。

第一阶段技术致命缺点是吞吐量太低，而费用又太高了。原因很明显：每次提交和取消订单都需要消耗一个以太坊交易。在提交订单的交易里，还要触发订单匹配。如果订单恰巧匹配到了一个或者多个对手单，就要做清结算，记录成交历史，做内部转账；如果订单不能匹配任何对手单，就需要把订单写入订单本。总之，在智能合约层面的逻辑实在是太多，任何合约的代码优化都是杯水车薪。

### 第二阶段

大约是 2017 年年初，当开发者们意识到第一阶段技术的缺陷时，他们开始尝试去做进一步的优化。路印就是这个时候开始研发自己协议的。实际上路印后来陆续发布的 1.0，1.5， 和 2.0 三个版本都属于第二阶段这个范畴。

这个阶段优化的思路其实很直接： 尽量把与资产安全相关度低的模块从智能合约中移除，放到链外的中心化系统中去运行，这样就可以避免对区块链的过渡依赖，从而提高吞吐量并降低成本。包括路印在内的许多 DEX 项目把这个链外的中心化系统称为中继（Relayer）。

从智能合约中移除的子系统包括：订单本，撮合引擎。账号子系统和充值提现子系统则被去掉，转而使用以太坊地址作为账号。留在智能合约中的就只有清结算子系统了，这个子系统的主要逻辑是验证订单和撮合的正确性，计算成交量，更新成交记录，并进行资产在链上的原子互换。

第二阶段的 DEX 产品理论上依然可以汇集整个网络的所有订单，但订单的管理和撮合由于是在中心化系统中完成的，因此就不再是“去中心化”交易所了。但开发者和社区依然把这种技术归类于去中心化技术，其主要原因有两个，第一是用户交易的资产依然是掌握在用户自己的地址中，因此从资产安全的角度讲，依然是“去中心化”，和以太坊的安全性一致的；第二是用户的订单可以被多个中继同时匹配，因此流动性是可以去中心化共享的。对这一阶段技术和产品更准确的一种描述应该是“非托管中心化交易所”技术。

第二阶段技术的优化结果如何呢？假设以太坊 15 秒出一个块，理论上这种技术每秒可以成交（吞吐量）2 到 3 笔，每个交易消耗的油费大约等值 13 美分左右 — 这个成本和以太坊价格成正比，13 美分是以太价格 190 美金计算得到的，如果我们期待以太价格未来会更高，那么撮合的成本也会同样增加。这个成本还和中继使用的 gas 价格相关。

知道了第二阶段技术的性能，如果还有人告诉你这个阶段的去中心化交易所将取代像币安，Coinbase 这样的中心化交易所，你会认同吗？我觉得用蚍蜉撼树来比喻也不为过。吞吐量还是太小，成本还是太高了。

如何才能进一步实现 DEX 的优化性能（这里专指吞吐量和成本）而不依赖于以太坊本身的扩容呢？这是个巨大的挑战。多数的 DEX 项目到第二阶段就无法实现技术上的突破了，等待主网扩容，成了他们唯一救命稻草。
