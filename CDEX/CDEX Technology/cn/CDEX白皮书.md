# CDEX 协议， polkadot 上的开放的去中心化交易所协议

## 摘要

CDEX 协议是基于 polkadot 的去中心化交易协议，任何人可以基于 CDEX 协议搭建属于自己的去中心化交易所。CDEX 协议具有去中心化交易所的基本特性，实现了链下订单中继、链上结算、交易记录可审查、去中心化资产托管。此外，CDEX 协议还实现了基于委托的链上资产结算机制和订单的链上撮合功能，为基于 CDEX 协议的交易所带来更好的体验。

## 背景

传统互联网是传递信息的网络，信息都保存在中心化的机构中，由于缺乏可靠的信任机制，陌生节点间无法完成大规模的价值交换。互联网的发展趋势必然是从信息互联网最终过渡到价值互联网。比特币的出现使得可信的价值转移成为了可能，带动了区块链技术的蓬勃发展。一大批区块链项目发行了自己的代币及公链。种类繁多的代币对于交换提出了强劲的需求，带动了去中心化 Token 互换协议的研究，陆陆续续涌现了 Etherdelta、 0x、IDEX 等基于以太坊去中心化交易协议。

然而 Etherdelta, IDEX 等由链上进行订单处理，结算等协议受限于以太坊的性能，导致用户体验很差，同时每个动作都需要消耗 gas，并且需要等待区块链的确认，极大影响了去中心化交易所的使用。为了解决该问题，0x 协议提出了链下处理订单、链上进行结算，通过把交易订单在链下让中继 relayer 撮合处理，然后再区块链上进行结算确认。这样结合两者之优势，在提升了交易速度的同时，又保证了安全性。

同时我们看到以 0x 协议为代表的价值交换协议却只能用于 ERC-20(ERC-721)代币，众多用于自己主网的代币例如 BTC, EOS, NEO 等无法通过去中心化协议进行交换、目前区块链间呈现出来的这种问题被称作“孤岛效应”，这种孤岛的限状极大影响了去中心化交易所的发展，生态无法对接，体系难以增长。想要形成一个真正的价值互联网，使得不同代币自由流转，就必须链与链之间价值流通的障碍。

polkadot 由以太坊联合创始人 Gavin Wood 创建，是一个旨在解决区块链间交互性的跨链项目。Polkadaot 独特的跨链机制旨在将当下各自独立的区块链网络串联起来，让不同链间可以进行通信和数据传递。

CDEX 是构建与 polkadot 之上的去中心化交易协议，依托于 polkadot 跨链机制，CDEX 将构建更大规模，公平、去中心的点对点数字交易，极大拓展去中心化交易所的使用范围。

### CDEX 架构

CDEX 协议的架构包含三部分。

作为去中心化的媒介，CDEX 智能合约部署在以太坊区块链上，可以存储用户的资产、交易记录，达到资产去中心化、交易记录可审计的目标。

Relayer 是订单中继系统，与 CDEX 智能合约交互，主要负责订单撮合与提交上链。Relayer 对外提供 OpenApi. 允许第三方交易所提交订单到撮合引擎。

第三方交易所的职责是收集用户提交的订单数据，并将签名的订单提交给 Relayer。 通过 R1 协议，不同交易所可以成为分布式商业系统的一部分，共享订单数据和流动性，为用户带来更好的交易深度和体验。

### 订单交易

#### 订单交易流程

订单交易流程描述了从用户提交订单开始，到 Relaye 撮合订单，再到交易数据提交到区块链上的过程。如图所示:

1. 用户输入订单信息。用户以一定价格和数量买入或者卖出 token， 客户端将数据转换成约定的订单数据格式。
2. 要监管户使用私钥对订单进行签名。私钥由用户保管，任何交易所以及 Relayer 不存储用户的私钥。放入后台订单池。 签名完成后，客户端将订单信息发送给 Relayer， Relayer 对订单信息进行合法性校验后，放入订单池进行撮合。
3. 后台撮合成功。Relayer 的撮合订单引擎对来自不同交易所得所有订单进行统一撮合。
4. 后台提交到链上交易。撮合成功后，Relayer 会将匹配到的两个订单信息及交易额提交到区块链上进行最终的结算。

#### 订单

每个订单是包含订单参数和关联签名的数据包。订单参数通过 Keccak SHA3 散列加密为 32 个字节。订单发起者使用其私钥对订单散列进行签名以产生 ECDSA 签名。

单数据格式，在交易所中，用户的订单体现为: 交易对 + 交易价格 + 交易数量。

参数说明如下:

● tokenBuy: 用户希望购买的 token 合约地址
● amountBuy: 用户 希望购买的 token 数量
● tokenSel: 用希望卖出的 token 合约地址
● amountSell: 用户希望卖出的 token 数量
● baseToken:交 易对锚定的基础 token。默认填 0，表示对 ETH 的交易对。如果是对 RNT 的交易对，此处填 RNT 的合约地址
● expires：订单过期区块数。默认设置-一个比较大的值，表示永不过期
● nonce: 随机数。 用来保证订单唯一性，目前的方案是 nonce 值为时间藏
●feeToken: 手续 费支付方式。如果为 0,按传统方法支付，即手续费从用户获得的 token 中扣除。如果为 token 合约地址，则使用该种 Token 支付手续费，前提是用户存入了该 token 到 R1 智能合约中

### Relayer 撮合

和 0x 协议相同，Relayer 主要负责订单撮合、钱包余额维护、提交上链等。Relayer 内部各自通组成如下图所示:

- OpenApi: Relayer 对外提供 API， 第三方可以通过 OpenAPI 提交订单、查询交易状态、 订单深度以及钱包余额。
- Valiator: 对订单数据合法性进行校验，对账户余额进行校验。
- AccountSystem: 负责维护钱包余额
- BlockSyncing：负责区块信息同步，同步区块链余额信息等。
- MatchingEngin：撮合引擎，负责撮合订单
- MatchingEngin: 撮合引擎，负责撮合订单
- MessageQueue: 消息系统。负责系统间通信。
- Store: 存储模块。负责存储信息。

Relayer 收到订单数据后的内部处理流程如下；

1. 对订单数据进行校验。 这里主要校验订单的哈希值是否匹配，防止订单数据被篡改；校验用户签名是否正确，确保订单数据缺失
2. taker 的订单数据(见订单数据格式一节说明)
3. maker 的签名信息(u, r, s)
4. taker 的签名信息 (u,r,s)
5. 交易额(Relayer 根据撮合结果设置本次交易额)
6. maker 和 taker 的应收手续费(由 Relayer 设置)
7. 接收手续费的账号(由 Relayer 设置)

### 交易流程

- 协议授权
  需要交易代币的用户 Y 先对 CDEX 智能合约进行授权，使其能够转出用户想要销售的代币 B（amountS）。该操作不会冻结用户的代币，在订单执行过程中，用户依然能够自由转移自己的代币。

- 创建订单
  中继或者其他中介负责提供代币的兑换率和订单表，用户可以借助人以完整的钱包界面定义卖出量 amountS, 买入量 amountBy 以及其他参数，从而发起一个订单(限价订单)。

- 订单广播
  钱包会将订单以及其数字签名发送到一个或多个中继。而后，中继会更新他们的公共订单表。

- 流动性共享

中继可以通过任意通信媒介对订单进行广播，这也再次说明各节点之间能够灵活的交流。
